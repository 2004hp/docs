---
layout: example-app 
title: "Web.py blog using RethinkDB"
github_url: "https://github.com/rethinkdb/rethinkdb-example-webpy-blog/"
active: docs
docs_active: examples
permalink: docs/examples/webpy-blog/
---
<div id="background"></div>
<table cellspacing=0 cellpadding=0>
    <thead>
        <tr>
            <th class=docs><h1>model.py</h1></th>
            <th class=code></th>
        </tr>
    </thead>
    <tbody>
        <tr id='section-1'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-1">&#182;</a>
                </div>
                <p>The <a href="http://webpy.org/">web.py</a> (really basic) <a href="http://webpy.org/src/blog/0.3">blog example</a> 
using <strong>RethinkDB as the backend for web.py applications</strong>.</p>

<p>For details about the complete stack, installation, and running the app see
the <a href="https://github.com/rethinkdb/rethinkdb-example-webpy-blog">README</a>.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">socket</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">web</span>

<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="kn">import</span> <span class="nn">rethinkdb</span> <span class="kn">as</span> <span class="nn">r</span>
<span class="kn">from</span> <span class="nn">rethinkdb.errors</span> <span class="kn">import</span> <span class="n">RqlRuntimeError</span></pre></div>
            </td>
        </tr>
        <tr id='section-Connection_details'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-Connection_details">&#182;</a>
                </div>
                <h3>Connection details</h3>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-3'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-3">&#182;</a>
                </div>
                <p>We will use these settings later in the code to
connect to the RethinkDB server.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="n">RDB_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s">&#39;host&#39;</span> <span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;RDB_HOST&#39;</span><span class="p">,</span> <span class="s">&#39;localhost&#39;</span><span class="p">),</span>
  <span class="s">&#39;port&#39;</span> <span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;RDB_PORT&#39;</span><span class="p">,</span> <span class="mi">28015</span><span class="p">),</span>
  <span class="s">&#39;db&#39;</span>   <span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;RDB_DB&#39;</span><span class="p">,</span> <span class="s">&#39;webpy&#39;</span><span class="p">),</span>
  <span class="s">&#39;table&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;RDB_TABLE&#39;</span><span class="p">,</span> <span class="s">&#39;blogposts&#39;</span><span class="p">)</span>
<span class="p">}</span></pre></div>
            </td>
        </tr>
        <tr id='section-4'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-4">&#182;</a>
                </div>
                <p>The <code>Connection</code> object returned by <a href="http://www.rethinkdb.com/api/#py:accessing_rql-connect"><code>r.connect</code></a> 
is a <a href="http://docs.python.org/2/library/stdtypes.html#typecontextmanager">context manager</a>
that can be used with the <code>with</code> statements.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="k">def</span> <span class="nf">connection</span><span class="p">():</span>
  <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">RDB_CONFIG</span><span class="p">[</span><span class="s">&#39;host&#39;</span><span class="p">],</span> <span class="n">port</span><span class="o">=</span><span class="n">RDB_CONFIG</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">],</span> <span class="n">db</span><span class="o">=</span><span class="n">RDB_CONFIG</span><span class="p">[</span><span class="s">&#39;db&#39;</span><span class="p">])</span></pre></div>
            </td>
        </tr>
        <tr id='section-Listing_existing_posts'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-Listing_existing_posts">&#182;</a>
                </div>
                <h3>Listing existing posts</h3>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-6'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-6">&#182;</a>
                </div>
                <p>To retrieve all existing tasks, we are using the
<a href="http://www.rethinkdb.com/api/#py:selecting_data-table"><code>r.table</code></a>
command to query the database in response to a GET request from the
browser. We also <a href="http://www.rethinkdb.com/api/#py:transformations-orderby"><code>order_by</code></a>
the <code>posted_at</code> attribute in a descending manner.</p>

<p>Running the query returns an iterator that automatically streams
data from the server in efficient batches.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="k">def</span> <span class="nf">get_posts</span><span class="p">():</span>
  <span class="k">with</span> <span class="n">connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">RDB_CONFIG</span><span class="p">[</span><span class="s">&#39;table&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">desc</span><span class="p">(</span><span class="s">&#39;posted_at&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span></pre></div>
            </td>
        </tr>
        <tr id='section-Creating_a_new_post'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-Creating_a_new_post">&#182;</a>
                </div>
                <h3>Creating a new post</h3>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-8'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-8">&#182;</a>
                </div>
                <p>We create a new blog entry using
<a href="http://www.rethinkdb.com/api/#py:writing_data-insert"><code>insert</code></a>.</p>

<p>The <code>insert</code> operation returns a single object specifying the number
of successfully created objects and their corresponding IDs:
<code>{ &quot;inserted&quot;: 1, &quot;errors&quot;: 0, &quot;generated_keys&quot;: [&quot;b3426201-9992-4a21-ab84-974603657671&quot;] }</code></p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="k">def</span> <span class="nf">new_post</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
  <span class="n">new_post</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> 
    <span class="s">&#39;content&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span> 
    <span class="s">&#39;posted_at&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
    <span class="s">&#39;last_modified&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">with</span> <span class="n">connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">RDB_CONFIG</span><span class="p">[</span><span class="s">&#39;table&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">new_post</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;inserted&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">new_post</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;generated_keys&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">return</span> <span class="n">new_post</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span></pre></div>
            </td>
        </tr>
        <tr id='section-Retrieving_a_single_post'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-Retrieving_a_single_post">&#182;</a>
                </div>
                <h3>Retrieving a single post</h3>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-10'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-10">&#182;</a>
                </div>
                <p>Every new post gets assigned a unique ID. The browser can retrieve
a specific task by GETing <code>/view/&lt;post_id&gt;</code>. To query the database
for a single document by its ID, we use the
<a href="http://www.rethinkdb.com/api/#py:selecting_data-get"><code>get</code></a>
command.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="k">def</span> <span class="nf">get_post</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
  <span class="k">with</span> <span class="n">connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">RDB_CONFIG</span><span class="p">[</span><span class="s">&#39;table&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span></pre></div>
            </td>
        </tr>
        <tr id='section-Updating_a_post'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-Updating_a_post">&#182;</a>
                </div>
                <h3>Updating a post</h3>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-12'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-12">&#182;</a>
                </div>
                <p>To update the post we&#39;ll use the 
<a href="http://www.rethinkdb.com/api/#py:writing_data-update"><code>update</code></a>
command, which will merge the JSON object stored in the database with the
new one.</p>

<p>The <code>update</code> operation returns an object specifying how many rows
have been updated.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="k">def</span> <span class="nf">update_post</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
  <span class="k">with</span> <span class="n">connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">RDB_CONFIG</span><span class="p">[</span><span class="s">&#39;table&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> \
      <span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> <span class="s">&#39;content&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span> <span class="s">&#39;last_modified&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()})</span> \
      <span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;modified&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span></pre></div>
            </td>
        </tr>
        <tr id='section-Deleting_a_post'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-Deleting_a_post">&#182;</a>
                </div>
                <h3>Deleting a post</h3>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-14'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-14">&#182;</a>
                </div>
                <p>To delete a post we&#39;ll call a
<a href="http://www.rethinkdb.com/api/#py:writing_data-delete"><code>delete</code></a>
command.</p>

<p>The <code>delete</code> operation returns an object specifying how many
rows have been deleted.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="k">def</span> <span class="nf">del_post</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
  <span class="k">with</span> <span class="n">connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">RDB_CONFIG</span><span class="p">[</span><span class="s">&#39;table&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;deleted&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span></pre></div>
            </td>
        </tr>
        <tr id='section-Database_setup'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-Database_setup">&#182;</a>
                </div>
                <h3>Database setup</h3>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-16'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-16">&#182;</a>
                </div>
                <p>The app will use the table <code>blogposts</code> in the database <code>webpy</code>. 
You can override these defaults by defining the <code>RDB_DB</code> and <code>RDB_TABLE</code>
env variables.</p>

<p>We&#39;ll create the database and table here using
<a href="http://www.rethinkdb.com/api/#py:manipulating_databases-db_create"><code>db_create</code></a>
and
<a href="http://www.rethinkdb.com/api/#py:manipulating_tables-table_create"><code>table_create</code></a> 
commands.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="k">def</span> <span class="nf">dbSetup</span><span class="p">():</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">RDB_CONFIG</span><span class="p">[</span><span class="s">&#39;host&#39;</span><span class="p">],</span> <span class="n">port</span><span class="o">=</span><span class="n">RDB_CONFIG</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">db_create</span><span class="p">(</span><span class="n">RDB_CONFIG</span><span class="p">[</span><span class="s">&#39;db&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="n">RDB_CONFIG</span><span class="p">[</span><span class="s">&#39;db&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">table_create</span><span class="p">(</span><span class="n">RDB_CONFIG</span><span class="p">[</span><span class="s">&#39;table&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;Database setup completed. Now run the app without --setup.&#39;</span>
    <span class="k">except</span> <span class="n">RqlRuntimeError</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;App database already exists. Run the app like this: `python blog.py`&#39;</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div>
            </td>
        </tr>
        <tr id='section-Best_practices'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-Best_practices">&#182;</a>
                </div>
                <h3>Best practices</h3>

<h4>Managing connections: a connection per request</h4>

<p>The RethinkDB server doesn&#39;t use a thread-per-connnection approach
so opening connections per request will not slow down your database.</p>

<h4>Fetching multiple rows: batched iterators</h4>

<p>When fetching multiple rows from a table, RethinkDB returns a
batched iterator initially containing a subset of the complete
result. Once the end of the current batch is reached, a new batch is
automatically retrieved from the server. From a coding point of view
this is transparent:</p>

<pre><code>for result in r.table(&#39;blogposts&#39;).run(conn):
    print result
</code></pre>

<h4><code>update</code> vs <code>replace</code></h4>

<p>Both <a href="http://www.rethinkdb.com/api/#py:writing_data-update"><code>update</code></a> and 
<a href="http://www.rethinkdb.com/api/#py:writing_data-replace"><code>replace</code></a> 
operations can be used to modify one or multiple rows. Their behavior is different:</p>

<ul>
<li>  <code>update</code> will merge existing rows with the new values</li>
<li>  <code>replace</code> will completely replace the existing rows with new values</li>
</ul>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-18'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-18">&#182;</a>
                </div>
                <p>Licensed under the MIT license: <a href="http://opensource.org/licenses/mit-license.php">http://opensource.org/licenses/mit-license.php</a></p>

<p>Copyright &copy; 2012 RethinkDB</p>

            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
    </tbody>
</table>
