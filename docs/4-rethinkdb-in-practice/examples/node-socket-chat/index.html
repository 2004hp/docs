---
layout: example-app 
title: "Node.js chat with Socket.IO, Express and RethinkDB"
github_url: "https://github.com/rethinkdb/rethinkdb-example-nodejs-chat/"
active: docs
docs_active: examples
permalink: docs/examples/node-socket-chat/
---
<div id="background"></div>
<table cellspacing=0 cellpadding=0>
    <thead>
        <tr>
            <th class=docs><h1>db.js</h1></th>
            <th class=code></th>
        </tr>
    </thead>
    <tbody>
        <tr id='section-1'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-1">&#182;</a>
                </div>
                <p>A fork of the <a href="https://github.com/eiriksm/chat-test-2k">node.js chat app</a> 
by <a href="https://twitter.com/orkj">@orkj</a> using socket.io, rethinkdb, passport and bcrypt on an express app.</p>

<p>See the <a href="https://github.com/rethinkdb/rethinkdb-example-nodejs-chat/blob/master/README.md">GitHub README</a>
for details of the complete stack, installation, and running the app.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;rethinkdb&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">logdebug</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)(</span><span class="s1">&#39;rdb:debug&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">logerror</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)(</span><span class="s1">&#39;rdb:error&#39;</span><span class="p">);</span></pre></div>
            </td>
        </tr>
        <tr id='section-Connection_details'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-Connection_details">&#182;</a>
                </div>
                <h4>Connection details</h4>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-3'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-3">&#182;</a>
                </div>
                <p>RethinkDB database settings. Defaults can be overridden using environment variables.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="kd">var</span> <span class="nx">dbConfig</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">host</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RDB_HOST</span> <span class="o">||</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
  <span class="nx">port</span><span class="o">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RDB_PORT</span><span class="p">)</span> <span class="o">||</span> <span class="mi">28015</span><span class="p">,</span>
  <span class="nx">db</span>  <span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RDB_DB</span> <span class="o">||</span> <span class="s1">&#39;chat&#39;</span><span class="p">,</span>
  <span class="nx">tables</span><span class="o">:</span> <span class="p">{</span>
    <span class="s1">&#39;messages&#39;</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cache&#39;</span><span class="o">:</span> <span class="s1">&#39;cid&#39;</span><span class="p">,</span>
    <span class="s1">&#39;users&#39;</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>
            </td>
        </tr>
        <tr id='section-4'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-4">&#182;</a>
                </div>
                <p>Connect to RethinkDB instance and perform a basic database setup:</p>

<ul>
<li>create the <code>RDB_DB</code> database (defaults to <code>chat</code>)</li>
<li>create tables <code>messages</code>, <code>cache</code>, <code>users</code> in this database</li>
</ul>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">setup</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">connect</span><span class="p">({</span><span class="nx">host</span><span class="o">:</span> <span class="nx">dbConfig</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="o">:</span> <span class="nx">dbConfig</span><span class="p">.</span><span class="nx">port</span> <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">err</span> <span class="o">===</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">dbCreate</span><span class="p">(</span><span class="nx">dbConfig</span><span class="p">.</span><span class="nx">db</span><span class="p">).</span><span class="nx">run</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">logdebug</span><span class="p">(</span><span class="s2">&quot;[DEBUG] RethinkDB database &#39;%s&#39; already exists (%s:%s)\n%s&quot;</span><span class="p">,</span> <span class="nx">dbConfig</span><span class="p">.</span><span class="nx">db</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">logdebug</span><span class="p">(</span><span class="s2">&quot;[INFO ] RethinkDB database &#39;%s&#39; created&quot;</span><span class="p">,</span> <span class="nx">dbConfig</span><span class="p">.</span><span class="nx">db</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">tbl</span> <span class="k">in</span> <span class="nx">dbConfig</span><span class="p">.</span><span class="nx">tables</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">tableName</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="nx">dbConfig</span><span class="p">.</span><span class="nx">db</span><span class="p">).</span><span class="nx">tableCreate</span><span class="p">(</span><span class="nx">tableName</span><span class="p">,</span> <span class="p">{</span><span class="nx">primaryKey</span><span class="o">:</span> <span class="nx">dbConfig</span><span class="p">.</span><span class="nx">tables</span><span class="p">[</span><span class="nx">tbl</span><span class="p">]}).</span><span class="nx">run</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">logdebug</span><span class="p">(</span><span class="s2">&quot;[DEBUG] RethinkDB table &#39;%s&#39; already exists (%s:%s)\n%s&quot;</span><span class="p">,</span> <span class="nx">tableName</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
              <span class="nx">logdebug</span><span class="p">(</span><span class="s2">&quot;[INFO ] RethinkDB table &#39;%s&#39; created&quot;</span><span class="p">,</span> <span class="nx">tableName</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">})(</span><span class="nx">tbl</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div>
            </td>
        </tr>
        <tr id='section-Filtering_results'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-Filtering_results">&#182;</a>
                </div>
                <h4>Filtering results</h4>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-6'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-6">&#182;</a>
                </div>
                <p>Find a user by email using the 
<a href="http://www.rethinkdb.com/api/#js:selecting_data-filter"><code>filter</code></a> function. 
We are using the simple form of <code>filter</code> accepting an object as an argument which
is used to perform the matching (in this case the attribute <code>mail</code> must be equal to
the value provided). </p>

<p>We only need one result back so we use <a href="http://www.rethinkdb.com/api/#js:transformations-limit"><code>limit</code></a>
to return it (if found). Results are <a href="http://www.rethinkdb.com/api/#js:accessing_rql-collect"><code>collect</code></a>ed
and passed as an array to the callback function. </p>

<blockquote>
<p><strong>param</strong> {String} mail<br>
   the email of the user that we search for</p>

<p><strong>param</strong> {Function} callback<br>
   callback invoked after collecting all the results </p>

<p><strong>returns</strong> {Object} the user if found, <code>null</code> otherwise   </p>
</blockquote>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">findUserByEmail</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mail</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">onConnect</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logdebug</span><span class="p">(</span><span class="s2">&quot;[INFO ][%s][findUserByEmail] Login {user: %s, pwd: &#39;you really thought I&#39;d log it?&#39;}&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">],</span> <span class="nx">mail</span><span class="p">);</span>

    <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="nx">dbConfig</span><span class="p">.</span><span class="nx">db</span><span class="p">).</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">filter</span><span class="p">({</span><span class="s1">&#39;mail&#39;</span><span class="o">:</span> <span class="nx">mail</span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">run</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">cursor</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">logerror</span><span class="p">(</span><span class="s2">&quot;[ERROR][%s][findUserByEmail][collect] %s:%s\n%s&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">],</span> <span class="nx">err</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">cursor</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">row</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">logerror</span><span class="p">(</span><span class="s2">&quot;[ERROR][%s][findUserByEmail][collect] %s:%s\n%s&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">],</span> <span class="nx">err</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">row</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="nx">connection</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">}</span>

    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div>
            </td>
        </tr>
        <tr id='section-7'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-7">&#182;</a>
                </div>
                <p>Every user document is assigned a unique id when created. Retrieving
a document by its id can be done using the
<a href="http://www.rethinkdb.com/api/#js:selecting_data-get"><code>get</code></a> function.</p>

<p>RethinkDB will use the primary key index to fetch the result.</p>

<blockquote>
<p><strong>param</strong> {String} userId<br>
   The ID of the user to be retrieved.</p>

<p><strong>param</strong> {Function} callback<br>
   callback invoked after collecting all the results </p>

<p><strong>returns</strong> {Object} the user if found, <code>null</code> otherwise  </p>
</blockquote>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">findUserById</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">onConnect</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="nx">dbConfig</span><span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">]).</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="nx">userId</span><span class="p">).</span><span class="nx">run</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">logerror</span><span class="p">(</span><span class="s2">&quot;[ERROR][%s][findUserById] %s:%s\n%s&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">],</span> <span class="nx">err</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">connection</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">});</span>    
  <span class="p">});</span>
<span class="p">};</span></pre></div>
            </td>
        </tr>
        <tr id='section-Retrieving_chat_messages'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-Retrieving_chat_messages">&#182;</a>
                </div>
                <h4>Retrieving chat messages</h4>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-9'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-9">&#182;</a>
                </div>
                <p>To find the last <code>max_results</code> messages ordered by <code>timestamp</code>,
we are using <a href="http://www.rethinkdb.com/api/#js:selecting_data-table"><code>table</code></a> to access
messages in the table, then we 
<a href="http://www.rethinkdb.com/api/#js:transformations-orderby"><code>orderBy</code></a> <code>timestamp</code> 
and instruct the server to return only <code>max_results</code> using 
<a href="http://www.rethinkdb.com/api/#js:transformations-limit"><code>limit</code></a>.</p>

<p>These operations are chained together and executed on the database. Results
are <a href="http://www.rethinkdb.com/api/#js:accessing_rql-collect"><code>collect</code></a>ed
and passed as an array to the callback function. </p>

<blockquote>
<p><strong>param</strong> {Number} max_results<br>
   Maximum number of results to be retrieved from the db</p>

<p><strong>param</strong> {Function} callback<br>
   callback invoked after collecting all the results</p>

<p><strong>returns</strong> {Array} an array of messages  </p>
</blockquote>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">findMessages</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">max_results</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">onConnect</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="nx">dbConfig</span><span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">]).</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">orderBy</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">desc</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)).</span><span class="nx">limit</span><span class="p">(</span><span class="nx">max_results</span><span class="p">).</span><span class="nx">run</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">cursor</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">logerror</span><span class="p">(</span><span class="s2">&quot;[ERROR][%s][findMessages] %s:%s\n%s&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">],</span> <span class="nx">err</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[]);</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">cursor</span><span class="p">.</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">logerror</span><span class="p">(</span><span class="s2">&quot;[ERROR][%s][findMessages][toArray] %s:%s\n%s&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">],</span> <span class="nx">err</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
            <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[]);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">results</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="nx">connection</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div>
            </td>
        </tr>
        <tr id='section-10'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-10">&#182;</a>
                </div>
                <p>To save a new chat message using we are using 
<a href="http://www.rethinkdb.com/api/#js:writing_data-insert"><code>insert</code></a>. </p>

<p>An <code>insert</code> op returns an object specifying the number
of successfully created objects and their corresponding IDs:
<code>{ &quot;inserted&quot;: 1, &quot;errors&quot;: 0, &quot;generated_keys&quot;: [&quot;b3426201-9992-ab84-4a21-576719746036&quot;] }</code></p>

<blockquote>
<p><strong>param</strong> {Object} msg<br>
   The message to be saved</p>

<p><strong>param</strong> {Function} callback<br>
   callback invoked once after the first result returned</p>

<p><strong>returns</strong> {Boolean} <code>true</code> if the user was created, <code>false</code> otherwise   </p>
</blockquote>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">saveMessage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">onConnect</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="nx">dbConfig</span><span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">]).</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">insert</span><span class="p">(</span><span class="nx">msg</span><span class="p">).</span><span class="nx">run</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">logerror</span><span class="p">(</span><span class="s2">&quot;[ERROR][%s][saveMessage] %s:%s\n%s&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">],</span> <span class="nx">err</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">inserted</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">connection</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div>
            </td>
        </tr>
        <tr id='section-11'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-11">&#182;</a>
                </div>
                <p>Adding a new user to database using  <a href="http://www.rethinkdb.com/api/#js:writing_data-insert"><code>insert</code></a>.</p>

<p>If the document to be saved doesn&#39;t have an <code>id</code> field, RethinkDB automatically
generates an unique <code>id</code>. This is returned in the result object.</p>

<blockquote>
<p><strong>param</strong> {Object} user<br>
  The user JSON object to be saved.</p>

<p><strong>param</strong> {Function} callback<br>
   callback invoked once after the first result returned</p>

<p><strong>returns</strong> {Boolean} <code>true</code> if the user was created, <code>false</code> otherwise  </p>
</blockquote>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">saveUser</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>  
  <span class="nx">onConnect</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="nx">dbConfig</span><span class="p">.</span><span class="nx">db</span><span class="p">).</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">insert</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">run</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">logerror</span><span class="p">(</span><span class="s2">&quot;[ERROR][%s][saveUser] %s:%s\n%s&quot;</span><span class="p">,</span> <span class="nx">connection</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">],</span> <span class="nx">err</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">inserted</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">connection</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div>
            </td>
        </tr>
        <tr id='section-Helper_functions'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-Helper_functions">&#182;</a>
                </div>
                <h4>Helper functions</h4>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-13'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-13">&#182;</a>
                </div>
                <p>A wrapper function for the RethinkDB API <code>r.connect</code>
to keep the configuration details in a single function
and fail fast in case of a connection error.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="kd">function</span> <span class="nx">onConnect</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">connect</span><span class="p">({</span><span class="nx">host</span><span class="o">:</span> <span class="nx">dbConfig</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="o">:</span> <span class="nx">dbConfig</span><span class="p">.</span><span class="nx">port</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">err</span> <span class="o">===</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
    <span class="nx">connection</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">10001</span><span class="p">);</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span></pre></div>
            </td>
        </tr>
        <tr id='section-Connection_management'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-Connection_management">&#182;</a>
                </div>
                <h4>Connection management</h4>

<p>This application uses a new connection for each query needed to serve
a user request. In case generating the response would require multiple
queries, the same connection should be used for all queries.</p>

<p>Example:</p>

<pre><code>onConnect(function (err, connection)) {
    if(err) { return callback(err); }

    query1.run(connection, callback);
    query2.run(connection, callback);
}
</code></pre>

            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
    </tbody>
</table>
