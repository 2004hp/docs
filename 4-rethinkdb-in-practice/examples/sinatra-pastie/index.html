---
layout: example-app 
title: "Pastie using RethinkDB and Sinatra"
github_url: "https://github.com/rethinkdb/rethinkdb-example-sinatra-pastie"
active: docs
docs_active: examples
permalink: docs/examples/sinatra-pastie/
---
<div id="background"></div>
<table cellspacing=0 cellpadding=0>
    <thead>
        <tr>
            <th class=docs><h1>repasties.rb</h1></th>
            <th class=code></th>
        </tr>
    </thead>
    <tbody>
        <tr id='section-1'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-1">&#182;</a>
                </div>
                <p>A simple <a href="http://pastie.org">Pastie</a>-like app inspired by Nick Plante&#39;s <a href="https://github.com/zapnap/toopaste">toopaste</a> project
showing how to use <strong>RethinkDB as a backend for Sinatra applications</strong>. </p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;sinatra&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;rethinkdb&#39;</span></pre></div>
            </td>
        </tr>
        <tr id='section-Connection_details'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-Connection_details">&#182;</a>
                </div>
                <h3>Connection details</h3>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-3'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-3">&#182;</a>
                </div>
                <p>We will use these settings later in the code to connect 
to the RethinkDB server.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="no">RDB_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RDB_HOST&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span> 
  <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RDB_PORT&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="mi">28015</span><span class="p">,</span>
  <span class="ss">:db</span>   <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RDB_DB&#39;</span><span class="o">]</span>   <span class="o">||</span> <span class="s1">&#39;repasties&#39;</span>
<span class="p">}</span></pre></div>
            </td>
        </tr>
        <tr id='section-4'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-4">&#182;</a>
                </div>
                <p>A friendlly shortcut for accessing ReQL functions</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="n">r</span> <span class="o">=</span> <span class="ss">RethinkDB</span><span class="p">:</span><span class="ss">:RQL</span><span class="o">.</span><span class="n">new</span></pre></div>
            </td>
        </tr>
        <tr id='section-Setting_up_the_database'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-Setting_up_the_database">&#182;</a>
                </div>
                <h3>Setting up the database</h3>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-6'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-6">&#182;</a>
                </div>
                <p>The app will use a table <code>snippets</code> in the database defined by the
environment variable <code>RDB_DB</code> (defaults to <code>repasties</code>).</p>

<p>We&#39;ll create the database and the table here using 
<a href="http://www.rethinkdb.com/api/#rb:manipulating_databases-db_create"><code>db_create</code></a>
and
<a href="http://www.rethinkdb.com/api/#rb:manipulating_tables-table_create"><code>table_create</code></a> commands.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="n">configure</span> <span class="k">do</span>
  <span class="n">set</span> <span class="ss">:db</span><span class="p">,</span> <span class="no">RDB_CONFIG</span><span class="o">[</span><span class="ss">:db</span><span class="o">]</span>
  <span class="n">connection</span> <span class="o">=</span> <span class="ss">RethinkDB</span><span class="p">:</span><span class="ss">:Connection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="no">RDB_CONFIG</span><span class="o">[</span><span class="ss">:host</span><span class="o">]</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="no">RDB_CONFIG</span><span class="o">[</span><span class="ss">:port</span><span class="o">]</span><span class="p">)</span>
  <span class="k">begin</span>
    <span class="n">r</span><span class="o">.</span><span class="n">db_create</span><span class="p">(</span><span class="no">RDB_CONFIG</span><span class="o">[</span><span class="ss">:db</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="no">RDB_CONFIG</span><span class="o">[</span><span class="ss">:db</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">table_create</span><span class="p">(</span><span class="s1">&#39;snippets&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
  <span class="k">rescue</span> <span class="ss">RethinkDB</span><span class="p">:</span><span class="ss">:RqlRuntimeError</span> <span class="o">=&gt;</span> <span class="n">err</span>
    <span class="nb">puts</span> <span class="s2">&quot;Database `repasties` and table `snippets` already exist.&quot;</span>
  <span class="k">ensure</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">close</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
            </td>
        </tr>
        <tr id='section-Managing_connections'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-Managing_connections">&#182;</a>
                </div>
                <h3>Managing connections</h3>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-8'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-8">&#182;</a>
                </div>
                <p>The pattern we&#39;re using for managing database connections is to have <strong>a connection per request</strong>. 
We&#39;re using Sinatra&#39;s <code>before</code> and <code>after</code> for 
<a href="http://www.rethinkdb.com/api/#rb:accessing_rql-connect">opening a database connection</a> and 
<a href="http://www.rethinkdb.com/api/#rb:accessing_rql-close">closing it</a> respectively.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="n">before</span> <span class="k">do</span>
  <span class="k">begin</span></pre></div>
            </td>
        </tr>
        <tr id='section-9'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-9">&#182;</a>
                </div>
                <p>When openning a connection we can also specify the database:</p>
            </td>
            <td class=code>
                <div class='highlight'><pre>    <span class="vi">@rdb_connection</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="no">RDB_CONFIG</span><span class="o">[</span><span class="ss">:host</span><span class="o">]</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="no">RDB_CONFIG</span><span class="o">[</span><span class="ss">:port</span><span class="o">]</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
  <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">err</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span> <span class="s2">&quot;Cannot connect to RethinkDB database </span><span class="si">#{</span><span class="no">RDB_CONFIG</span><span class="o">[</span><span class="ss">:host</span><span class="o">]</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="no">RDB_CONFIG</span><span class="o">[</span><span class="ss">:port</span><span class="o">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">#{</span><span class="n">err</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="n">halt</span> <span class="mi">501</span><span class="p">,</span> <span class="s1">&#39;This page could look nicer, unfortunately the error is the same: database not available.&#39;</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
            </td>
        </tr>
        <tr id='section-10'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-10">&#182;</a>
                </div>
                <p>After each request we <a href="http://www.rethinkdb.com/api/#rb:accessing_rql-close">close the database connection</a>.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="n">after</span> <span class="k">do</span>
  <span class="k">begin</span>
    <span class="vi">@rdb_connection</span><span class="o">.</span><span class="n">close</span> <span class="k">if</span> <span class="vi">@rdb_connection</span>
  <span class="k">rescue</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span> <span class="s2">&quot;Couldn&#39;t close connection&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
  <span class="vi">@snippet</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">erb</span> <span class="ss">:new</span>
<span class="k">end</span></pre></div>
            </td>
        </tr>
        <tr id='section-11'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-11">&#182;</a>
                </div>
                <p>We create a new snippet in response to a POST request using
<a href="http://www.rethinkdb.com/api/#rb:writing_data-insert"><code>table.insert</code></a>.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="n">post</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
  <span class="vi">@snippet</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:snippet_title</span><span class="o">]</span><span class="p">,</span>
    <span class="ss">:body</span>  <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:snippet_body</span><span class="o">]</span><span class="p">,</span>
    <span class="ss">:lang</span>  <span class="o">=&gt;</span> <span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:snippet_lang</span><span class="o">]</span> <span class="o">||</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">downcase</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="vi">@snippet</span><span class="o">[</span><span class="ss">:body</span><span class="o">].</span><span class="n">empty?</span>
    <span class="n">erb</span> <span class="ss">:new</span>
  <span class="k">end</span>

  <span class="k">if</span> <span class="vi">@snippet</span><span class="o">[</span><span class="ss">:title</span><span class="o">].</span><span class="n">empty?</span>
    <span class="vi">@snippet</span><span class="o">[</span><span class="ss">:title</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@snippet</span><span class="o">[</span><span class="ss">:body</span><span class="o">].</span><span class="n">scan</span><span class="p">(</span><span class="sr">/\w+/</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">erb</span> <span class="ss">:new</span>
  <span class="k">end</span>

  <span class="vi">@snippet</span><span class="o">[</span><span class="ss">:created_at</span><span class="o">]</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_i</span>
  <span class="vi">@snippet</span><span class="o">[</span><span class="ss">:formatted_body</span><span class="o">]</span> <span class="o">=</span> <span class="n">pygmentize</span><span class="p">(</span><span class="vi">@snippet</span><span class="o">[</span><span class="ss">:body</span><span class="o">]</span><span class="p">,</span> <span class="vi">@snippet</span><span class="o">[</span><span class="ss">:lang</span><span class="o">]</span><span class="p">)</span>

  <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;snippets&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="vi">@snippet</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="vi">@rdb_connection</span><span class="p">)</span></pre></div>
            </td>
        </tr>
        <tr id='section-12'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-12">&#182;</a>
                </div>
                <p>The <code>insert</code> operation returns a single object specifying the number
of successfully created objects and their corresponding IDs
<code>{&quot;inserted&quot;: 1, &quot;errors&quot;: 0, &quot;generated_keys&quot;: [&quot;fcb17a43-cda2-49f3-98ee-1efc1ac5631d&quot;]}</code></p>
            </td>
            <td class=code>
                <div class='highlight'><pre>  <span class="k">if</span> <span class="n">result</span><span class="o">[</span><span class="s1">&#39;inserted&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">redirect</span> <span class="s2">&quot;/</span><span class="si">#{</span><span class="n">result</span><span class="o">[</span><span class="s1">&#39;generated_keys&#39;</span><span class="o">][</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">else</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span> <span class="n">result</span>
    <span class="n">redirect</span> <span class="s1">&#39;/&#39;</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
            </td>
        </tr>
        <tr id='section-13'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-13">&#182;</a>
                </div>
                <p>Every new snippet gets assigned automatically a unique ID. 
The browser can retrieve a specific snippet by 
GETing <code>/&lt;snippet_id&gt;</code>. To query the database for a single document by its ID, we use the
<a href="http://www.rethinkdb.com/api/#rb:selecting_data-get"><code>get</code></a> command.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="n">get</span> <span class="s1">&#39;/:id&#39;</span> <span class="k">do</span>
  <span class="vi">@snippet</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;snippets&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="vi">@rdb_connection</span><span class="p">)</span>

  <span class="k">if</span> <span class="vi">@snippet</span>
    <span class="vi">@snippet</span><span class="o">[</span><span class="s1">&#39;created_at&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="vi">@snippet</span><span class="o">[</span><span class="s1">&#39;created_at&#39;</span><span class="o">]</span><span class="p">)</span>
    <span class="n">erb</span> <span class="ss">:show</span>
  <span class="k">else</span>
    <span class="n">redirect</span> <span class="s1">&#39;/&#39;</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
            </td>
        </tr>
        <tr id='section-14'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-14">&#182;</a>
                </div>
                <p>Retrieving the latest <code>max_results</code> (default 10) snippets by their language 
by chaining together <a href="http://www.rethinkdb.com/api/#rb:selecting_data-filter"><code>filter</code></a>,
<a href="http://www.rethinkdb.com/api/#rb:transformations-pluck"><code>pluck</code></a>, and
<a href="http://www.rethinkdb.com/api/#rb:transformations-orderby"><code>order_by</code></a>. 
All chained operations are executed on the database server and the results are
returned as a batched iterator.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="n">get</span> <span class="s1">&#39;/lang/:lang&#39;</span> <span class="k">do</span>
  <span class="vi">@lang</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:lang</span><span class="o">].</span><span class="n">downcase</span>
  <span class="n">max_results</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:limit</span><span class="o">]</span> <span class="o">||</span> <span class="mi">10</span>
  <span class="n">results</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;snippets&#39;</span><span class="p">)</span><span class="o">.</span>
              <span class="n">filter</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span> <span class="o">=&gt;</span> <span class="vi">@lang</span><span class="p">)</span><span class="o">.</span>
              <span class="n">pluck</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">)</span><span class="o">.</span>
              <span class="n">order_by</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">desc</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">))</span><span class="o">.</span>
              <span class="n">limit</span><span class="p">(</span><span class="n">max_results</span><span class="p">)</span><span class="o">.</span>
              <span class="n">run</span><span class="p">(</span><span class="vi">@rdb_connection</span><span class="p">)</span>

  <span class="vi">@snippets</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">to_a</span>
  <span class="vi">@snippets</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">[</span><span class="s1">&#39;created_at&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">s</span><span class="o">[</span><span class="s1">&#39;created_at&#39;</span><span class="o">]</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">erb</span> <span class="ss">:list</span>
<span class="k">end</span></pre></div>
            </td>
        </tr>
        <tr id='section-15'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-15">&#182;</a>
                </div>
                <p>List of languages for which syntax highlighting is supported.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="no">SUPPORTED_LANGUAGES</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;Ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;Python&#39;</span><span class="p">,</span> <span class="s1">&#39;Javascript&#39;</span><span class="p">,</span> <span class="s1">&#39;Bash&#39;</span><span class="p">,</span> <span class="s1">&#39;ActionScript&#39;</span><span class="p">,</span> 
  <span class="s1">&#39;AppleScript&#39;</span><span class="p">,</span> <span class="s1">&#39;Awk&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;C++&#39;</span><span class="p">,</span> <span class="s1">&#39;Clojure&#39;</span><span class="p">,</span> 
  <span class="s1">&#39;CoffeeScript&#39;</span><span class="p">,</span> <span class="s1">&#39;Lisp&#39;</span><span class="p">,</span> <span class="s1">&#39;Erlang&#39;</span><span class="p">,</span> <span class="s1">&#39;Fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;Groovy&#39;</span><span class="p">,</span>
  <span class="s1">&#39;Haskell&#39;</span><span class="p">,</span> <span class="s1">&#39;Io&#39;</span><span class="p">,</span> <span class="s1">&#39;Java&#39;</span><span class="p">,</span> <span class="s1">&#39;Lua&#39;</span><span class="p">,</span> <span class="s1">&#39;Objective-C&#39;</span><span class="p">,</span> 
  <span class="s1">&#39;OCaml&#39;</span><span class="p">,</span> <span class="s1">&#39;Perl&#39;</span><span class="p">,</span> <span class="s1">&#39;Prolog&#39;</span><span class="p">,</span> <span class="s1">&#39;Scala&#39;</span><span class="p">,</span> <span class="s1">&#39;Smalltalk&#39;</span><span class="o">].</span><span class="n">sort</span></pre></div>
            </td>
        </tr>
        <tr id='section-16'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-16">&#182;</a>
                </div>
                <p>A Sinatra helper to expose the list of languages to views.</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">languages</span>
    <span class="no">SUPPORTED_LANGUAGES</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
            </td>
        </tr>
        <tr id='section-17'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-17">&#182;</a>
                </div>
                <p>Code is run through <a href="http://pygments.org/">Pygments</a> for syntax
highlighting. If it&#39;s not installed, locally, use a webservice http://pygments.appspot.com/.
(code inspired by <a href="http://rtomayko.github.com/rocco/">rocco.rb</a>)</p>
            </td>
            <td class=code>
                <div class='highlight'><pre><span class="k">unless</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;PATH&#39;</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span> <span class="no">File</span><span class="o">.</span><span class="n">executable?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">dir</span><span class="si">}</span><span class="s2">/pygmentize&quot;</span><span class="p">)</span> <span class="p">}</span>
  <span class="nb">warn</span> <span class="s2">&quot;WARNING: Pygments not found. Using webservice.&quot;</span>
  <span class="no">PYGMENTIZE</span><span class="o">=</span><span class="kp">false</span>
<span class="k">else</span>
  <span class="no">PYGMENTIZE</span><span class="o">=</span><span class="kp">true</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">pygmentize</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">lang</span><span class="o">.</span><span class="n">eql?</span> <span class="s1">&#39;text&#39;</span>
    <span class="k">return</span> <span class="n">code</span>
  <span class="k">end</span>
  <span class="n">lang</span><span class="o">.</span><span class="n">downcase!</span>
  <span class="k">if</span> <span class="no">PYGMENTIZE</span>
    <span class="n">highlight_pygmentize</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="n">highlight_webservice</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">highlight_pygmentize</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
  <span class="n">code_html</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;|pygmentize -l </span><span class="si">#{</span><span class="n">lang</span><span class="si">}</span><span class="s2"> -f html -O encoding=utf-8,style=colorful,linenos=1&quot;</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">fd</span><span class="o">|</span>
    <span class="n">pid</span> <span class="o">=</span>
      <span class="nb">fork</span> <span class="p">{</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">close_read</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">write</span> <span class="n">code</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">close_write</span>
        <span class="nb">exit!</span>
      <span class="p">}</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">close_write</span>
    <span class="n">code_html</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">close_read</span>
    <span class="no">Process</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">code_html</span>
<span class="k">end</span>

<span class="nb">require</span> <span class="s1">&#39;net/http&#39;</span>

<span class="k">def</span> <span class="nf">highlight_webservice</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
  <span class="n">url</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span> <span class="s1">&#39;http://pygments.appspot.com/&#39;</span>
  <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lang&#39;</span> <span class="o">=&gt;</span> <span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span> <span class="o">=&gt;</span> <span class="n">code</span><span class="p">}</span>
  <span class="ss">Net</span><span class="p">:</span><span class="ss">:HTTP</span><span class="o">.</span><span class="n">post_form</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">body</span>
<span class="k">end</span></pre></div>
            </td>
        </tr>
        <tr id='section-Best_practices'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-Best_practices">&#182;</a>
                </div>
                <h3>Best practices</h3>

<h4>Managing connections: a connection per request</h4>

<p>The RethinkDB server doesn&#39;t use a thread-per-connnection approach
so opening connections per request will not slow down your database.</p>

<h4>Fetching multiple rows: batched iterators</h4>

<p>When fetching multiple rows from a table, RethinkDB returns a
batched iterator initially containing a subset of the complete
result. Once the end of the current batch is reached, a new batch is
automatically retrieved from the server. From a coding point of view
this is transparent:</p>

<pre><code>r.table(&#39;todos&#39;).run(g.rdb_conn).each do |result|
    print result
end
</code></pre>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-Credit'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-Credit">&#182;</a>
                </div>
                <h3>Credit</h3>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-20'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-20">&#182;</a>
                </div>
                <ul>
<li>This sample app was inspired by Nick Plante&#39;s <a href="https://github.com/zapnap/toopaste">toopaste</a> project.</li>
<li>The snippets of code used for syntax highlighting are from Ryan Tomayko&#39;s <a href="https://github.com/rtomayko/rocco">rocco.rb</a> project.</li>
<li>Snippets code highlighting is done using <a href="http://pygments.org">Pygments</a> or the <a href="http://pygments.appspot.com/">Pygments web service</a></li>
<li>The <a href="https://gist.github.com/1573884">Solarized dark Pygments stylesheet</a> was created by Zameer Manji</li>
</ul>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-License'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-License">&#182;</a>
                </div>
                <h3>License</h3>
            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
        <tr id='section-22'>
            <td class=docs>
                <div class="pilwrap">
                    <a class="pilcrow" href="#section-22">&#182;</a>
                </div>
                <p>This demo application is licensed under the MIT license: <a href="http://opensource.org/licenses/mit-license.php">http://opensource.org/licenses/mit-license.php</a></p>

            </td>
            <td class=code>
                <div class='highlight'><pre></pre></div>
            </td>
        </tr>
    </tbody>
</table>
